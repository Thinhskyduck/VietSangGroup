<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Quản Trị Nội Dung - Việt Sáng</title>

  <!-- 1. Ra lệnh cho CMS chờ -->
  <script>window.CMS_MANUAL_INIT = true;</script>
  
  <!-- 2. Chỉ tải Decap CMS và TinyMCE. KHÔNG TẢI REACT BÊN NGOÀI -->
  <script src="https://unpkg.com/decap-cms@^3.0.0/dist/decap-cms.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/tinymce@7.0.0/tinymce.min.js"></script>
</head>
<body>
  <script>
    function initializeCMS() {
      // Chờ cho CMS và TinyMCE sẵn sàng
      if (window.CMS && window.tinymce) {
        
        // 3. Lấy hàm `createElement` (biến 'h') TRỰC TIẾP từ Decap CMS
        const h = window.CMS.h;

        // 4. Tạo Widget bằng class. Đây là cách làm ổn định nhất
        //    và không gây xung đột React.
        var TinymceControl = createClass({
          componentDidMount: function() {
            const el = document.createElement("textarea");
            el.value = this.props.value || "";
            this.el.appendChild(el);

            tinymce.init({
              target: el,
              height: 600,
              menubar: false,
              plugins: "link image lists code table media wordcount anchor autoresize textcolor",
              toolbar: "undo redo | blocks | bold italic underline strikethrough | forecolor backcolor | alignleft aligncenter alignright alignjustify | bullist numlist outdent indent | link image table media | removeformat | code",
              setup: (editor) => {
                editor.on("init", () => {
                  if (this.props.value) editor.setContent(this.props.value);
                });
                editor.on("change keyup", () => {
                  this.props.onChange(editor.getContent());
                });
              },
            });
          },

          componentWillUnmount: function() {
            if (this.el && this.el.firstChild) {
              tinymce.remove(this.el.firstChild);
            }
          },

          render: function() {
            return h("div", {
              ref: (el) => {
                this.el = el;
              },
            });
          },
        });

        CMS.registerWidget("tinymce", TinymceControl);

        CMS.init({
          config: {
            backend: {
              name: "github",
              repo: "Thinhskyduck/VietSangGroup",
              branch: "blog-dev",
            },
            media_folder: "img/uploads",
            public_folder: "/img/uploads",
            collections: [
              {
                name: "blog",
                label: "Tin Tức & Bài Viết",
                folder: "_posts",
                create: true,
                slug: "{{year}}-{{month}}-{{day}}-{{slug}}",
                extension: "md",
                fields: [
                  { label: "Tiêu đề", name: "title", widget: "string" },
                  { label: "Ngày đăng", name: "date", widget: "datetime" },
                  { label: "Tác giả", name: "author", widget: "string", default: "Việt Sáng Home" },
                  { label: "Ảnh đại diện", name: "image", widget: "image", required: false },
                  { label: "Tóm tắt ngắn", name: "summary", widget: "text", required: false },
                  { label: "Nội dung chi tiết", name: "body", widget: "tinymce" },
                ],
              },
            ],
          },
        });

      } else {
        setTimeout(initializeCMS, 200);
      }
    }
    initializeCMS();
  </script>
</body>
</html>